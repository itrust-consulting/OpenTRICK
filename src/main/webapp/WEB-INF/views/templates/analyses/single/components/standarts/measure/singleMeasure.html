<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Measure Status</title>
</head>
<body>

    <!-- Locale check and setting -->
    <th:block th:if="${locale == null}">
        <th:block th:with="locale=${#locale.getDefault()}"></th:block>
    </th:block>

    <th:block th:with="language=${locale.language}">
        <!-- Setting language as request attribute -->
    </th:block>

    <!-- Message variables -->
    <th:block th:with="statusM=${#messages.msg('label.measure.status.m')}"
              th:with="statusAP=${#messages.msg('label.measure.status.ap')}"
              th:with="statusOP=${#messages.msg('label.measure.status.op')}"
              th:with="statusEX=${#messages.msg('label.measure.status.ex')}"
              th:with="statusNA=${#messages.msg('label.measure.status.na')}"
              th:with="titleStatusM=${#messages.msg('label.title.measure.status.m')}"
              th:with="titleStatusAP=${#messages.msg('label.title.measure.status.ap')}"
              th:with="titleStatusOP=${#messages.msg('label.title.measure.status.op')}"
              th:with="titleStatusEX=${#messages.msg('label.title.measure.status.ex')}"
              th:with="titleStatusNA=${#messages.msg('label.title.measure.status.na')}">
    </th:block>

    <!-- Loop for importance values -->
    <th:block th:each="impValue : ${#numbers.sequence(1, 3)}">
        <th:block th:with="imp${impValue}=${#messages.msg('label.measure.importance.value', impValue)}"
                  th:with="titleImp${impValue}=${#messages.msg('label.title.measure.importance.value', impValue)}">
        </th:block>
    </th:block>

    <!-- Set locale to French in session -->
    <th:block th:with="locale='fr'">
        <th:block th:attr="session:locale=${locale}"></th:block>
    </th:block>

    <!-- Setting the implementation rate value -->
    <th:block th:with="implementationRate=${measure.getImplementationRateValue(valueFactory)}"></th:block>

    <!-- CSS handling based on implementation rate -->
    <th:block th:with="css=${implementationRate < 100 and not (measure.status == 'NA' or measure.status == 'EX') ? 'editable' : ''}"></th:block>

    <!-- Setting todo CSS -->
    <th:block th:with="todoCSS=${measure.toDo == null and css.contains('editable') ? 'danger' : css}"></th:block>

    <!-- Measure description text -->
    <th:block th:with="measureDescriptionText=${measure.measureDescription.getMeasureDescriptionTextByAlpha2(language)}"></th:block>

    <!-- Double-click action -->
    <th:block th:with="dblclickaction=${isEditable and (analysisOnly or (type == 'quantitative' and measure.measureDescription.computable and selectedStandard.computable and selectedStandard.type != 'MATURITY')) ? 'ondblclick=\"return editMeasure(this, ' + standardid + ',' + measure.id + ');\"' : ''}"></th:block>

    <!-- Popover reference for description tooltip -->
    <th:block th:with="popoverRef=${measure.measureDescription.reference != null or measureDescriptionText.description != null ? 'data-toggle=\"tooltip\" data-container=\"body\" data-trigger=\"click\" data-placement=\"auto\" data-title=\"' + #messages.msg(measureDescriptionText.description) + '\" style=\"cursor: pointer;\"' : ''}"></th:block>

    <!-- Implementation rate attribute -->
    <th:block th:with="implementationRateAttr=${(type == 'QUALITATIVE' or not showDynamicAnalysis) ? 'data-trick-min-value=\"0\" data-trick-max-value=\"100\" data-trick-step-value=\"1\"' : 'data-trick-list-value=\"dataListImplementationRate\"'}"></th:block>

    <!-- Check for linked ticket -->
    <th:block th:with="hasTicket=${isLinkedToProject and measure.ticket != null}"></th:block>
    <tr th:data-trick-computable="false" th:data-trick-reference="${measure.measureDescription.reference}"
    th:onclick="|selectElement(this); reloadMeasureRow('${measure.id}','${standardid}');|"
    th:data-trick-class="'Measure'" class="active" th:data-trick-id="${measure.id}"
    th:data-is-linked="${hasTicket}" th:attr="th:dblclickaction=${dblclickaction}">
    <div th:if="${isLinkedToProject or analysisOnly and isEditable}">
        <td>
            <input type="checkbox" th:disabled="${analysisOnly ? true : false}" class="checkbox"
                   th:onchange="|updateMenu(this,'#section_standard_${standardid}','#menu_standard_${standardid}');|">
        </td>
    </div>
    <td>
        <div th:if="${hasTicket}">
            <div th:if="${isNoClientTicketing}">
                <span style="white-space: nowrap;">
                    <i class="fa fa-paper-plane" style="font-size: 8px;" aria-hidden="true"></i>
                    <span th:text="${measure.measureDescription.reference}"></span>
                </span>
            </div>
            <div th:unless="${isNoClientTicketing}">
                <span th:utext="${ticketLink}"></span>
            </div>
        </div>
        <div th:unless="${hasTicket}">
            <div th:if="${isNoClientTicketing}">
                <span style="white-space: nowrap;">
                    <i class="fa fa-paper-plane-o" style="font-size: 8px;" aria-hidden="true"></i>
                    <span th:text="${measure.measureDescription.reference}"></span>
                </span>
            </div>
            <div th:if="${isLinkedToProject}">
                <span style="white-space: nowrap;">
                    <i class="fa fa-chain-broken" style="font-size: 10px" aria-hidden="true"></i>
                    <span th:text="${measure.measureDescription.reference}"></span>
                </span>
            </div>
            <div th:unless="${isNoClientTicketing or isLinkedToProject}">
                <span th:text="${measure.measureDescription.reference}"></span>
            </div>
        </div>
    </td>
    <td th:attr="th:popoverRef=${popoverRef}">
        <span th:text="${!empty measureDescriptionText ? measureDescriptionText.domain : ''}"></span>
    </td>
    <td th:attr="th:data-trick-field='toCheck' th:data-trick-field-type='string'"
        th:onclick="|return editField(this);|">
        <span th:text="${measure.toCheck}"></span>
    </td>
    <td th:attr="th:data-trick-field='comment' th:data-trick-field-type='string'"
        th:onclick="|return editField(this);|">
        <span th:text="${measure.comment}"></span>
    </td>
    <td></td>
    </tr>
    <tr th:unless="${measure.measureDescription.computable}" th:data-trick-class="Measure" 
        th:data-trick-id="${measure.id}" th:data-trick-reference="${measure.measureDescription.reference}"
        th:onclick="|selectElement(this); reloadMeasureRow('${measure.id}','${standardid}');|"
        th:data-is-linked="${isLinkedToProject and not empty measure.ticket}">
        <div th:if="${isLinkedToProject or analysisOnly and isEditable}">
            <td>
                <input type="checkbox" th:disabled="${measure.status == 'NA' or measure.status == 'EX' ? true : false}" 
                    class="checkbox" th:onchange="|updateMenu(this,'#section_standard_${standardid}','#menu_standard_${standardid}');|">
            </td>
        </div>
        <td th:attr="th:popoverRef">
            <span th:text="${!empty measureDescriptionText ? measureDescriptionText.domain : ''}"></span>
        </td>
        <td th:attr="th:data-trick-field='status' th:data-trick-choose='M,AP,OP,EX,NA'"
            th:data-trick-choose-translate="${statusM},${statusAP},${statusOP},${statusEX},${statusNA}"
            th:data-trick-choose-title="${titleStatusM},${titleStatusAP},${titleStatusOP},${titleStatusEX},${titleStatusNA}"
            th:data-trick-field-type="string" th:onclick="|return editField(this);|"
            th:data-trick-callback="reloadMeasureAndCompliance('${standardid}','${measure.id}')">
            <span th:switch="${measure.status}">
                <span th:case="'NA'" th:text="${statusNA}"></span>
                <span th:case="'AP'" th:text="${statusAP}"></span>
                <span th:case="'OP'" th:text="${statusOP}"></span>
                <span th:case="'EX'" th:text="${statusEX}"></span>
                <span th:default="true" th:text="${statusM}"></span>
            </span>
        </td>
        <fmt:formatNumber value="${implementationRate}" maxFractionDigits="0" minFractionDigits="0" var="implementationRateValue" />
        <div th:if="${standardType.name == 'MATURITY'}">
            <td th:attr="th:data-trick-field='implementationRate' th:data-trick-class='MaturityMeasure' 
                th:data-trick-field-type='double' th:title="${implementationRateValue} %" 
                th:data-trick-callback="reloadMeasureAndCompliance('${standardid}','${measure.id}');updateMeasureEffience('${measure.measureDescription.reference}');"
                th:onclick="|return editField(this);|">
                <span th:text="${implementationRateValue}"></span>
            </td>
        </div>
        <div th:unless="${standardType.name == 'MATURITY'}">
            <td th:attr="th:data-trick-field='implementationRate' th:data-trick-field-type='string'" 
                th:title="${implementationRateValue} %" th:data-trick-callback="reloadMeasureAndCompliance('${standardid}','${measure.id}')"
                th:onclick="|return editField(this);|">
                <span th:text="${implementationRateValue}"></span>
            </td>
        </div>
        <td th:attr="th:data-trick-field='internalWL' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);" th:data-trick-min-value="0">
            <fmt:formatNumber value="${measure.internalWL}" maxFractionDigits="2" />
        </td>
        <td th:attr="th:data-trick-field='externalWL' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);" th:data-trick-min-value="0">
            <fmt:formatNumber value="${measure.externalWL}" maxFractionDigits="2" />
        </td>
        <td th:attr="th:data-trick-field='investment' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);" th:data-trick-min-value="0" 
            th:title="${measure.investment * 0.001}">
            <fmt:formatNumber value="${measure.investment * 0.001}" maxFractionDigits="0" />
        </td>
        <td th:attr="th:data-trick-field='lifetime' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);" th:data-trick-min-value="0">
            <fmt:formatNumber value="${measure.lifetime}" maxFractionDigits="2" />
        </td>
        <td th:attr="th:data-trick-field='internalMaintenance' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);">
            <fmt:formatNumber value="${measure.internalMaintenance}" maxFractionDigits="2" />
        </td>
        <td th:attr="th:data-trick-field='externalMaintenance' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);">
            <fmt:formatNumber value="${measure.externalMaintenance}" maxFractionDigits="2" />
        </td>
        <td th:attr="th:data-trick-field='recurrentInvestment' th:data-trick-field-type='double'"
            th:onclick="|return editField(this);" th:title="${measure.recurrentInvestment * 0.001}">
            <fmt:formatNumber value="${measure.recurrentInvestment * 0.001}" maxFractionDigits="0" />
        </td>
        <td th:attr="th:data-trick-field='phase' th:data-trick-field-type='integer'"
            th:onclick="|return editField(this);" th:data-trick-callback-pre="extractPhase(this)">
            <span th:switch="${measure.phase.number}">
                <span th:case="'0'" th:text="'NA'"></span>
                <span th:default="true" th:text="${measure.phase.number}"></span>
            </span>
        </td>
        <td th:attr="th:data-trick-field='importance' th:data-trick-field-type='integer'"
            th:onclick="|return editField(this);" th:data-trick-choose="1,2,3"
            th:data-trick-choose-translate="${imp1},${imp2},${imp3}" th:data-trick-choose-title="${titleImp1},${titleImp2},${titleImp3}">
            <span th:switch="${measure.importance}">
                <span th:case="'1'" th:text="${imp1}"></span>
                <span th:case="'2'" th:text="${imp2}"></span>
                <span th:case="'3'" th:text="${imp3}"></span>
            </span>
        </td>
        <td th:attr="th:data-trick-field='responsible' th:data-trick-field-type='string'">
            <span th:text="${measure.responsible}"></span>
        </td>
        <div th:if="${standardType.name == 'NORMAL' or standardType.name == 'ASSET'}">
            <td th:attr="th:data-trick-field='toCheck' th:data-trick-content='text' th:data-trick-field-type='string'">
                <span th:text="${measure.toCheck}"></span>
            </td>
        </div>
        <td th:attr="th:data-trick-field='comment' th:data-trick-content='text' th:data-trick-field-type='string'"
            th:onclick="|return editField(this);">
            <span th:text="${measure.comment}"></span>
        </td>
        <td th:attr="th:data-trick-field='toDo' th:data-trick-content='text' th:data-trick-field-type='string'"
            th:onclick="|return editField(this);">
            <span th:text="${measure.toDo}"></span>
        </td>
    </tr>
</body>
</html>
